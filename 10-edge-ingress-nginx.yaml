---
# ==========================================
# Edge: ingress-nginx Controller (단일 노드용)
# - NPM을 대체하는 "쿠버네티스 엣지"
# - hostNetwork=true 로 EC2의 80/443 포트를 직접 수신
# - Ingress 리소스(호스트 기반 라우팅 규칙)를 읽어서 Service로 전달
# ==========================================
---
# ----------------------------
# ServiceAccount
# - ingress controller Pod가 K8s 리소스를 읽기 위해 필요
# ----------------------------
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress-nginx
  namespace: edge

---
# ----------------------------
# ClusterRole
# - ingress controller가 cluster 전반의 ingress/service/endpoints 등을 "조회"할 수 있어야 함
# - (운영 정석: 최소권한 + 읽기 중심)
# ----------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ingress-nginx
rules:
  # Ingress/IngressClass 조회
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "ingressclasses", "ingresses/status"]
    verbs: ["get", "list", "watch", "update"]

  # Service/Endpoints/Pods 등 라우팅 대상 조회
  - apiGroups: [""]
    resources: ["services", "endpoints", "pods", "secrets", "configmaps", "namespaces", "events"]
    verbs: ["get", "list", "watch"]

  # EndpointSlice 사용 환경 대비(최근 K8s에서 사용)
  - apiGroups: ["discovery.k8s.io"]
    resources: ["endpointslices"]
    verbs: ["get", "list", "watch"]

---
# ----------------------------
# ClusterRoleBinding
# - edge 네임스페이스의 ServiceAccount에 위 ClusterRole 권한 부여
# ----------------------------
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx
subjects:
  - kind: ServiceAccount
    name: ingress-nginx
    namespace: edge

---
# ----------------------------
# ConfigMap (선택)
# - nginx 동작 옵션(프록시 타임아웃, 바디 크기 등)을 중앙에서 조정
# ----------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-controller
  namespace: edge
data:
  # WebSocket/SSE 등 장시간 연결 대비(기본값보다 늘림)
  proxy-read-timeout: "3600"
  proxy-send-timeout: "3600"

  # 업로드/요청 바디 크기 제한(필요시 조정)
  proxy-body-size: "50m"

---
# ----------------------------
# Deployment: ingress-nginx controller
# - hostNetwork=true : EC2 80/443 직접 수신(단일 노드에서 가장 단순)
# ----------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingress-nginx-controller
  namespace: edge
  labels:
    app: ingress-nginx
spec:
  replicas: 1  # 단일 노드에서는 1개가 현실적(80/443 포트 + hostNetwork)
  selector:
    matchLabels:
      app: ingress-nginx
  template:
    metadata:
      labels:
        app: ingress-nginx
    spec:
      serviceAccountName: ingress-nginx

      # ✅ 단일 노드에서 외부 80/443을 "그대로" 받기 위한 설정
      # - NPM(hostNetwork) 방식과 동일한 진입 방식
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      containers:
        - name: controller

          # ingress-nginx 컨트롤러 이미지 (버전 고정 권장)
          image: registry.k8s.io/ingress-nginx/controller:v1.11.2
          imagePullPolicy: IfNotPresent

          args:
            # IngressClass 이름(아래 Ingress에 ingressClassName: nginx 로 지정)
            - /nginx-ingress-controller
            - --ingress-class=nginx
            - --controller-class=k8s.io/ingress-nginx
            - --watch-ingress-without-class=false

            # ConfigMap 연결
            - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller

            # publish-service는 hostNetwork 구성에서는 필수는 아니지만,
            # 일부 환경에서 external IP 표시에 도움됨(원치 않으면 제거 가능)
            - --publish-status-address=98.88.27.53

          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          ports:
            # hostNetwork라서 실제로 EC2의 80/443에 직접 바인딩됨
            - name: http
              containerPort: 80
            - name: https
              containerPort: 443

          # 리소스(단일 노드에서 control-plane 자원 잠식 방지)
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "700m"
              memory: "1Gi"

          # 기본적인 보안 옵션(너무 강하게 잠그면 기능이 깨질 수 있어 적당선)
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]

---
# ----------------------------
# IngressClass
# - Ingress 리소스에서 ingressClassName: nginx 로 지정하면 이 컨트롤러가 처리
# ----------------------------
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
spec:
  controller: k8s.io/ingress-nginx
