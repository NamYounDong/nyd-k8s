apiVersion: networking.k8s.io/v1   # Ingress 리소스가 사용하는 API 버전 (K8s v1.19+ 표준)
kind: Ingress                      # 외부(HTTP/HTTPS) 트래픽을 클러스터 내부 Service로 라우팅하는 리소스

metadata:                          # Ingress 리소스 메타데이터 시작
  name: jenkins-ingress            # Ingress 이름. 보통 "<서비스명>-ingress" 형태로 네이밍
  namespace: cicd                  # Ingress가 속한 namespace. Service(jenkins-svc)와 동일해야 함

  annotations:                     # Ingress Controller(Nginx)에 전달할 추가 설정들
    ######
    # [중요] Jenkins 특성상 웹 응답이 느릴 수 있음
    # - Job 로그 스트리밍
    # - 대용량 콘솔 출력
    # - 플러그인 로딩 / 초기 부팅
    # 기본 타임아웃(60초)으로는 연결이 끊기는 경우가 있어 넉넉하게 설정
    ######

    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"  # 업스트림(Jenkins)에서 응답을 기다리는 최대 시간(초)
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"  # 클라이언트로 응답을 전송할 때 허용하는 최대 시간(초)
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true" # HTTPS 리다이렉트 강제


spec:                              # Ingress 동작 규칙 정의 시작
  ingressClassName: nginx          # 이 Ingress를 처리할 Ingress Controller 지정
                                   # 클러스터에 nginx ingress controller가 설치되어 있어야 함
  tls:                             # TLS 설정
    - hosts:                      # 도메인 이름
        - jenkins.dm-nyd.shop     # 도메인 이름
      secretName: wildcard-dm-nyd-shop-tls # 시크릿 이름(wildcard-dm-nyd-shop-tls)

  rules:                           # 호스트/경로 기반 라우팅 규칙 목록
    - host: jenkins.dm-nyd.shop    # 외부에서 접근할 도메인 이름
                                   # DNS A/AAAA 레코드는 Ingress Controller의 외부 IP를 가리켜야 함

      http:                        # HTTP 기반 라우팅 설정
        paths:                     # URL 경로 규칙 목록
          - path: /                # 루트(/)로 들어오는 모든 요청을
            pathType: Prefix       # Prefix = "/"로 시작하는 모든 경로 매칭
                                   # (/login, /job/xxx, /static 등 Jenkins 모든 URL 포함)

            backend:               # 실제 트래픽을 전달할 대상(백엔드)
              service:             # Kubernetes Service 지정
                name: jenkins-svc  # 트래픽을 받을 Service 이름
                                   # 반드시 같은 namespace(cicd)에 존재해야 함
                port:
                  number: 8080     # Service가 노출하는 포트
                                   # Jenkins 기본 웹 포트(컨테이너 내부 8080과 매칭)

###### 
# [전체 트래픽 흐름 정리]
# 사용자 브라우저
#   → jenkins.dm-nyd.shop (DNS)
#   → Ingress Controller(Nginx)
#   → Ingress Rule(host/path 매칭)
#   → Service(jenkins-svc:8080)
#   → Jenkins Pod(컨테이너)
#
# [실무 체크리스트]
# 1) Ingress Controller 설치 여부
#    kubectl get pods -n ingress-nginx
# 2) 도메인 DNS가 Ingress Controller 외부 IP를 가리키는지
#    kubectl get svc -n ingress-nginx
# 3) Service(jenkins-svc)가 정상인지
#    kubectl get svc -n cicd
#
# [확장 포인트]
# - HTTPS 사용 시:
#   * cert-manager + TLS 설정 추가
#   * annotations에 ssl-redirect, cert-manager 관련 옵션 추가
# - 보안 강화:
#   * basic auth / oauth proxy / IP whitelist 적용 가능
######
